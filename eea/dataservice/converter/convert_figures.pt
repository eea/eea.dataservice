<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

<metal:javascript fill-slot="javascript_head_slot">
  <script tal:attributes="src string:$portal_url/++resource++eea.dataservice.convert_figures.js"
    type="text/javascript"></script>
</metal:javascript>

<body>

<div metal:fill-slot="main"
     tal:define="convert python:request.get('convert', None);
                 figures python:request.get('figures', None)">
 <h1 i18n:translate="">Convert figures</h1>

 <div tal:condition="convert">
   <p class="documentDescription" i18n:translate="">
     This operation might take a while, a notification
     will be sent to user@eea.europa.eu after each convertion is done.
   </p>
   <p class="documentDescription" i18n:translate="">
     The following figures will be converted:
   </p>

   <ul id="figures-to-convert">
     <tal:figures repeat="figure figures">
       <li tal:define="figure_ob python:context[figure];
                       figure_title python:figure_ob.pretty_title_or_id;
                       figure_id python:figure_ob.getId()">
          <img tal:attributes="id string:${figure_id}-loading;
                               src string:${context/absolute_url}/ajax-loader-small.gif" />
          <strong style="color: red" i18n:translate=""
                  tal:attributes="id string:${figure_id}-label">converting</strong>
          <span tal:content="figure_title"
                tal:attributes="id figure_id" />
          <p tal:attributes="id string:${figure_id}-status" />
       </li>
     </tal:figures>
   </ul>
 </div>

 <form name="frmConvert" method="put" id="convert-all"
       tal:condition="not:convert"
       tal:attributes="action string:${context/absolute_url}/@@convertFigures">

  <p class="documentDescription" i18n:translate="">
    Select figures to be converted.
  </p>

  <input class="context" type="submit" name="convert" value="Convert" />

  <br /><br />
  <input type="checkbox" name="checkAll" id="checkAll" value="Check all" title="Check all" />
  <label for="checkAll" title="Check all" i18n:translate="">Check all</label>

 <dl class="convert-all-figures">
  <tal:figures repeat="figure python:context.objectValues('EEAFigureFile')">
   <dt tal:define="figure_title figure/pretty_title_or_id;
                   figure_id figure/getId">
     <input type="checkbox" name="figures:list"
            tal:attributes="value figure_id;
                            id figure_id;
                            title figure_title" />
     <label tal:content="figure_title"
            tal:attributes="title figure_title;
                            for figure_id"/>
   </dt>
   <dd>
     state:
     <tal:state content="python:context.portal_workflow.getInfoFor(figure, 'review_state', 'Unknown')" />
   </dd>
   <dd>
     filename:
     <tal:filename content="figure/getFilename" />
   </dd>
   <dd tal:define="info figure/@@convertionInfo">
     last converted:
     <tal:date condition="info" content="python:toLocalizedTime(info, long_format=1)" />
     <tal:date condition="not:info"> - </tal:date>
   </dd>
  </tal:figures>
 </dl>

 </form>
</div>

</body>
</html>
